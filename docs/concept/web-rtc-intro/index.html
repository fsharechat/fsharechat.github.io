<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=3">
<meta httpequiv="x-ua-compatible" content="ie=edge">
<meta property="og:type" content="website">
<meta name="author" content="fsharechat">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@questdb">
<meta name="generator" content="Docusaurus v2.0.0-alpha.64">
<link href="https://www.googletagmanager.com" rel="dns-prefetch">
<link href="https://www.google-analytics.com" rel="dns-prefetch">
<link rel="shortcut icon" href="https://https://fsharechat.github.io//img/favicon.png">
<link rel="apple-touch-icon" sizes="48x48" href="/img/icons/icon-48x48.png">
<link rel="apple-touch-icon" sizes="72x72" href="/img/icons/icon-72x72.png">
<link rel="apple-touch-icon" sizes="96x96" href="/img/icons/icon-96x96.png">
<link rel="apple-touch-icon" sizes="144x144" href="/img/icons/icon-144x144.png">
<link rel="apple-touch-icon" sizes="192x192" href="/img/icons/icon-192x192.png">
<link rel="apple-touch-icon" sizes="256x256" href="/img/icons/icon-256x256.png">
<link rel="apple-touch-icon" sizes="384x384" href="/img/icons/icon-384x384.png">
<link rel="apple-touch-icon" sizes="512x512" href="/img/icons/icon-512x512.png">
<link rel="sitemap" type="application/xml" href="/sitemap.xml">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="飞享IM-即时IM通讯系统  Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="飞享IM-即时IM通讯系统  Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H6YPVFKWXP"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-H6YPVFKWXP",{anonymize_ip:!0})</script>
<link rel="search" type="application/opensearchdescription+xml" title="飞享IM-即时IM通讯系统 " href="/opensearch.xml">
<link rel="icon" href="/img/favicon.png">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#d14671">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#21222c">
<link rel="apple-touch-icon" href="/img/favicon.png">
<link rel="mask-icon" href="/img/favicon.png" content="#fff">
<meta name="msapplication-TileImage" content="/img/favicon.png">
<meta name="msapplication-TileColor" content="#21222c"><title data-react-helmet="true">实时音视频开发的工程化实践 | 飞享IM-即时IM通讯系统 </title><meta data-react-helmet="true" property="og:image" content="https://https://fsharechat.github.io//img/og.png"><meta data-react-helmet="true" name="twitter:image" content="https://https://fsharechat.github.io//img/og.png"><meta data-react-helmet="true" name="twitter:description" content="飞享IM 做技术自主可控的即时通讯IM"><meta data-react-helmet="true" name="twitter:title" content="Introduction | 飞享IM-即时IM通讯系统 "><meta data-react-helmet="true" name="twitter:image:alt" content="Image for &quot;Introduction | 飞享IM-即时IM通讯系统 &quot;"><meta data-react-helmet="true" property="og:title" content="实时音视频开发的工程化实践 | 飞享IM-即时IM通讯系统 "><meta data-react-helmet="true" name="description" content="这里只是根据实时音视频开发，说明技术的路线，主要展示该技术得以工程应用需要的理论背景。该篇不是主要将实时音视频的所涉及的音视频相关的理论知识，由于实时音视频的相关的处理算法并不是本篇内容的关注重点，这里只是重点从工程角度说明WebRTC这项技术在简化实时音视频方面带来的帮助，然后围绕这项技术说明在服务端，客户端领域我们需要理解哪些工程化问题"><meta data-react-helmet="true" property="og:description" content="这里只是根据实时音视频开发，说明技术的路线，主要展示该技术得以工程应用需要的理论背景。该篇不是主要将实时音视频的所涉及的音视频相关的理论知识，由于实时音视频的相关的处理算法并不是本篇内容的关注重点，这里只是重点从工程角度说明WebRTC这项技术在简化实时音视频方面带来的帮助，然后围绕这项技术说明在服务端，客户端领域我们需要理解哪些工程化问题"><meta data-react-helmet="true" property="og:url" content="https://https://fsharechat.github.io//docs/concept/web-rtc-intro"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="true"><link data-react-helmet="true" rel="canonical" href="https://https://fsharechat.github.io//docs/concept/web-rtc-intro"><link rel="stylesheet" href="/styles.6808db04.css">
</head>
<body itemscope itemtype="http://schema.org/Organization">
<meta itemprop="name" content="飞享IM 做技术自主可控的即时通讯IM">
<meta itemprop="description" content="飞享IM 做技术自主可控的即时通讯IM">
<meta itemprop="url" content="https://https://fsharechat.github.io/">
<meta itemprop="logo" content="https://https://fsharechat.github.io//img/favicon.png">
<meta itemprop="sameAs" content="https://weibo.com/comsince">
<meta itemprop="sameAs" content="https://www.linkedin.com/company/comsince/">
<meta itemprop="sameAs" content="https://www.crunchbase.com/organization/quest-db">
<meta itemprop="sameAs" content="https://github.com/fsharechat">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner inner_3txf"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand brand_9Wyn" href="/"><img alt="fsharechat" class="navbar__logo" src="/img/navbar/fshare.svg"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">安装</a><ul class="dropdown__menu"><li><a class="dropdown__link" position="left" href="/docs/guide/centos/">Centos</a></li><li><a class="dropdown__link" position="left" href="/docs/guide/ubuntu/">Ubuntu</a></li><li><a class="dropdown__link" position="left" href="/docs/guide/windows/">Windows</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/introduction/">文档</a><a class="navbar__item navbar__link" href="/blog/">博客</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/fsharechat" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link navbar__item--github">GitHub</a><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span><span class="DocSearch-Button-Key">⌘</span><span class="DocSearch-Button-Key">K</span></button><a class="getStarted_1xnS button_Ni2_ button--primary_316O button--uppercase_35Ce button--xsmall_3jz_" href="/getstarted/">客户端下载</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand brand_9Wyn" href="/"><img alt="fsharechat" class="navbar__logo" src="/img/navbar/fshare.svg"></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a target="_blank" rel="noopener noreferrer" class="menu__link menu__link--sublist">安装</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/guide/centos/">Centos</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/guide/ubuntu/">Ubuntu</a></li><li class="menu__list-item"><a class="menu__link" position="left" href="/docs/guide/windows/">Windows</a></li></ul></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/introduction/">文档</a></li><li class="menu__list-item"><a class="menu__link" href="/blog/">博客</a></li><li class="menu__list-item"><a href="https://github.com/fsharechat" target="_blank" rel="noopener noreferrer" class="menu__link navbar__item--github">GitHub</a></li></ul></div></div></div></nav><div class="wrapper_1hNx"><div class="doc_2sKW"><div class="docs-sidebar doc__sidebar_1koD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">概述</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">系统架构</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concept/tech-doc">即时聊天系统技术文档</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/concept/web-rtc-intro">实时音视频开发的工程化实践</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concept/muti-conference-rtc">多人音视频会话方案预研</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/concept/delivery-read-report">送达与已读回执的设计方案说明</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#!">安装准备</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/prepare/mysql">MySQL基本安装</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/prepare/minio">Minio基本安装说明</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/prepare/cert">证书配置说明</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/prepare/nginx">Nginx安装配置说明</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/prepare/coturn">Coturn服务安装</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#!">安装指南</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guide/centos">Centos上单机部署实践</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guide/ubuntu">Ubuntu上单机部署实践</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guide/windows">Windows单机部署实践</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/guide/cluster">飞享IM集群架构与安装说明</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#!">开放接口</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/api/pushapi">发送系统通知</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#!">服务咨询</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/consult/contact">商业合作咨询事项说明</a></li></ul></li></ul></div></div></div><main class="doc__main_23K2"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">实时音视频开发的工程化实践</h1></header><div class="markdown"><p>这里只是根据实时音视频开发，说明技术的路线，主要展示该技术得以工程应用需要的理论背景。该篇不是主要将实时音视频的所涉及的音视频相关的理论知识，由于实时音视频的相关的处理算法并不是本篇内容的关注重点，这里只是重点从工程角度说明<code>WebRTC</code>这项技术在简化实时音视频方面带来的帮助，然后围绕这项技术说明在服务端，客户端领域我们需要理解哪些工程化问题</p><blockquote><p>基于平台的 API 做应用开发，并不是一个可以走得多远的方向，真正有价值的地方在于与具体的业务方向结合。这个是业务领域精通的指导思想，所有的技术都要找到相应的落地点</p></blockquote><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="网络基础"></a>网络基础<a aria-hidden="true" tabindex="-1" class="hash-link" href="#网络基础" title="Direct link to heading">#</a></h2><p>  TCP/IP网络基础，IP路由，网络分层，以及数据如何自顶而下实现传输</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="webrtc实时音视频技术的整体架构介绍"></a>WebRTC实时音视频技术的整体架构介绍<a aria-hidden="true" tabindex="-1" class="hash-link" href="#webrtc实时音视频技术的整体架构介绍" title="Direct link to heading">#</a></h2><p>  对webRTC整体技术有所了解，进而进一步了解我主要的学习重点，以及我们在开发实时聊天时需要解决的问题，可以参考这篇文章<a href="http://www.52im.net/thread-284-1-1.html" target="_blank" rel="noopener noreferrer">WebRTC实时音视频技术的整体架构介绍</a></p><blockquote><p>WebRTC技术架构图</p></blockquote><p>  <img src="http://www.52im.net/data/attachment/forum/201605/05/111321jf5oiev7fnznfnon.png" alt="image"></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="webrtc服务器"></a>WebRTC服务器<a aria-hidden="true" tabindex="-1" class="hash-link" href="#webrtc服务器" title="Direct link to heading">#</a></h2><p>  理解实时语音通信相关的通信策略，如何进行呼叫应答。也即是在建立媒体流之前如何进行对端链接，这需要信令服务器与turn服务器的配合</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="webrtc协议概述"></a>WebRTC协议概述<a aria-hidden="true" tabindex="-1" class="hash-link" href="#webrtc协议概述" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="理解p2p穿透技术"></a>理解p2p穿透技术<a aria-hidden="true" tabindex="-1" class="hash-link" href="#理解p2p穿透技术" title="Direct link to heading">#</a></h4><ul><li><a href="http://www.52im.net/thread-557-1-1.html" target="_blank" rel="noopener noreferrer">P2P技术之STUN、TURN、ICE详解</a></li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="webrtc协议"></a>WebRTC协议<a aria-hidden="true" tabindex="-1" class="hash-link" href="#webrtc协议" title="Direct link to heading">#</a></h4><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="nat"></a>NAT<a aria-hidden="true" tabindex="-1" class="hash-link" href="#nat" title="Direct link to heading">#</a></h5><p>网络地址转换协议Network Address Translation (NAT) 用来给你的（私网）设备映射一个公网的IP地址的协议。一般情况下，路由器的WAN口有一个公网IP，所有连接这个路由器LAN口的设备会分配一个私有网段的IP地址（例如192.168.1.3）。私网设备的IP被映射成路由器的公网IP和唯一的端口，通过这种方式不需要为每一个私网设备分配不同的公网IP，但是依然能被外网设备发现。</p><p>一些路由器严格地限定了部分私网设备的对外连接。这种情况下，即使STUN服务器识别了该私网设备的公网IP和端口的映射，依然无法和这个私网设备建立连接。这种情况下就需要转向TURN协议。</p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="stun"></a>STUN<a aria-hidden="true" tabindex="-1" class="hash-link" href="#stun" title="Direct link to heading">#</a></h5><p>NAT的会话穿越功能Session Traversal Utilities for NAT (STUN) (缩略语的最后一个字母是NAT的首字母)是一个允许位于NAT后的客户端找出自己的公网地址，判断出路由器阻止直连的限制方法的协议。</p><p>客户端通过给公网的STUN服务器发送请求获得自己的公网地址信息，以及是否能够被（穿过路由器）访问。</p><p><img src="http://image.comsince.cn/webrtc-stun.png" alt="image"></p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="turn"></a>TURN<a aria-hidden="true" tabindex="-1" class="hash-link" href="#turn" title="Direct link to heading">#</a></h5><p>一些路由器使用一种“对称型NAT”的NAT模型。这意味着路由器只接受和对端先前建立的连接（就是下一次请求建立新的连接映射）。</p><p>NAT的中继穿越方式Traversal Using Relays around NAT (TURN) 通过TURN服务器中继所有数据的方式来绕过“对称型NAT”。你需要在TURN服务器上创建一个连接，然后告诉所有对端设备发包到服务器上，TURN服务器再把包转发给你。很显然这种方式是开销很大的，所以只有在没得选择的情况下采用。</p><p><img src="http://image.comsince.cn/webrtc-turn.png" alt="image"></p><h5><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="ice"></a>ICE<a aria-hidden="true" tabindex="-1" class="hash-link" href="#ice" title="Direct link to heading">#</a></h5><p>交互式连接设施Interactive Connectivity Establishment (ICE) 是一个允许你的浏览器和对端浏览器建立连接的协议框架。在实际的网络当中，有很多原因能导致简单的从A端到B端直连不能如愿完成。这需要绕过阻止建立连接的防火墙，给你的设备分配一个唯一可见的地址（通常情况下我们的大部分设备没有一个固定的公网地址），如果路由器不允许主机直连，还得通过一台服务器转发数据。ICE使用以上技术实现</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="信令与视频通话"></a>信令与视频通话<a aria-hidden="true" tabindex="-1" class="hash-link" href="#信令与视频通话" title="Direct link to heading">#</a></h3><p>描述信令服务器在实现点对点视频通话的作用，说明如何协商并建立通话链接，详情参考<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebRTC_API/Signaling_and_video_calling" target="_blank" rel="noopener noreferrer">信令与视频通话</a></p><blockquote><p>这篇文章介绍ice协议框架与与信令服务在通信中扮演的角色<a href="https://rtcdeveloper.com/t/topic/13742" target="_blank" rel="noopener noreferrer">WebRTC 入门教程（二）WebRTC信令控制与STUN/TURN服务器搭建</a></p></blockquote><p>信令服务器在其中扮演中重要角色，因此良好的实时通讯信令设计，决定一个实时音视频通讯的关键，需要信令服务器帮助通信两端建立链接，下图为链接的流程图</p><p><img src="http://image.comsince.cn/webrtc-signal-process.png" alt="image"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="信令交换流程"></a>信令交换流程<a aria-hidden="true" tabindex="-1" class="hash-link" href="#信令交换流程" title="Direct link to heading">#</a></h3><blockquote><p>所有的程序逻辑都围绕这个信令交换流程进行代码编写，因此理解信令交换流程至关重要，前面已经对信令服务器,Stun,turn服务器做过简单介绍，现在主要说明它们之间是如何进行协同工作的</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="信令事务流程"></a>信令事务流程<a aria-hidden="true" tabindex="-1" class="hash-link" href="#信令事务流程" title="Direct link to heading">#</a></h4><p><img src="http://image.comsince.cn/WebRTC%20-%20Signaling%20Diagram.svg" alt="image"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="ice-候选交换过程"></a>ICE 候选交换过程<a aria-hidden="true" tabindex="-1" class="hash-link" href="#ice-候选交换过程" title="Direct link to heading">#</a></h4><p><img src="http://image.comsince.cn/WebRTC%20-%20ICE%20Candidate%20Exchange.svg" alt="image"></p><p><strong>NOTE:</strong> 详情请参考：<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebRTC_API/Signaling_and_video_calling" target="_blank" rel="noopener noreferrer">信令与视频通话</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="实践"></a>实践<a aria-hidden="true" tabindex="-1" class="hash-link" href="#实践" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="熟悉webrtc相关api"></a>熟悉WebRTC相关API<a aria-hidden="true" tabindex="-1" class="hash-link" href="#熟悉webrtc相关api" title="Direct link to heading">#</a></h3><ul><li><a href="https://javascript.ruanyifeng.com/htmlapi/webrtc.html#toc1" target="_blank" rel="noopener noreferrer">WebRTC API</a></li></ul><blockquote><p>学习相关平台的API，如何采集本地音视频资源显示，如何进行候选通知，详情参考<a href="https://github.com/webrtc/samples" target="_blank" rel="noopener noreferrer">webrtc-samples</a></p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="定义通话信令格式"></a>定义通话信令格式<a aria-hidden="true" tabindex="-1" class="hash-link" href="#定义通话信令格式" title="Direct link to heading">#</a></h3><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="web-rtc核心api流程"></a>web-rtc核心API流程<a aria-hidden="true" tabindex="-1" class="hash-link" href="#web-rtc核心api流程" title="Direct link to heading">#</a></h3><blockquote><p>这里以js相关接口说明其核心流程，Android版本api基本类似</p></blockquote><ul><li>创建peerConnection  </li></ul><p>创建peerConnection，建立与Turn服务器链接，此时应该设置相关的callback回调事件监听相关的事件生成回调，具体如下：</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-js codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">async</span><span class="token plain"> </span><span class="token function" style="color:#8be9fd">createPeerConnection</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">log</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token string" style="color:#f1fa8c">&quot;Setting up a connection...&quot;</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#6272a4">// Create an RTCPeerConnection which knows to use our chosen</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#6272a4">// STUN server.</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">myPeerConnection</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">new</span><span class="token plain"> </span><span class="token class-name">RTCPeerConnection</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">          iceServers</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token plain">     </span><span class="token comment" style="color:#6272a4">// Information about ICE servers - Use your own!</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">              urls</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;turn:turn.liyufan.win:3478&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain">  </span><span class="token comment" style="color:#6272a4">// A TURN server</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">              username</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;wfchat&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">              credential</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;wfchat&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token comment" style="color:#6272a4">// Set up event handlers for the ICE negotiation process.</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">      </span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">myPeerConnection</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">onicecandidate</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">handleICECandidateEvent</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">myPeerConnection</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">oniceconnectionstatechange</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">handleICEConnectionStateChangeEvent</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">myPeerConnection</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">onicegatheringstatechange</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">handleICEGatheringStateChangeEvent</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">myPeerConnection</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">onsignalingstatechange</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">handleSignalingStateChangeEvent</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">myPeerConnection</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">onnegotiationneeded</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">handleNegotiationNeededEvent</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">        </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">myPeerConnection</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">ontrack</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">handleTrackEvent</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div></div></div><ul><li>设置track以启动ICE协商</li></ul><blockquote><p>众所周知，要想启动ICE协商，必须将音视频流加入到<code>peerconnection</code>中，这样才能促发<code>handleNegotiationNeededEvent</code>事件回调，加入track事件代码如下：</p></blockquote><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-js codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token keyword" style="color:#ff79c6">try</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">webcamStream</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">getTracks</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">forEach</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">            </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method-variable function-variable method function property-access" style="color:#8be9fd">transceiver</span><span class="token plain"> </span><span class="token operator" style="color:#ff79c6">=</span><span class="token plain"> </span><span class="token parameter">track</span><span class="token plain"> </span><span class="token arrow operator" style="color:#ff79c6">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">myPeerConnection</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">addTransceiver</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">track</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain">streams</span><span class="token punctuation" style="color:#f8f8f2">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">[</span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token property-access">webcamStream</span><span class="token punctuation" style="color:#f8f8f2">]</span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"> </span><span class="token keyword" style="color:#ff79c6">catch</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">          </span><span class="token keyword" style="color:#ff79c6">this</span><span class="token punctuation" style="color:#f8f8f2">.</span><span class="token method function property-access" style="color:#8be9fd">handleGetUserMediaError</span><span class="token punctuation" style="color:#f8f8f2">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#f8f8f2">)</span><span class="token punctuation" style="color:#f8f8f2">;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="消息交互流程"></a>消息交互流程<a aria-hidden="true" tabindex="-1" class="hash-link" href="#消息交互流程" title="Direct link to heading">#</a></h3><ul><li>发送者发送<code>CallStartMessage</code>给接收者，并启动启动video track进行视频预览</li><li>接收者接收<code>CallStartMessage</code>,开启会话，弹出视频会话窗口，等待用户确定是否接收音视频请求</li><li>接收者如果同意接听，则发送<code>AnswerTMessage</code>，<code>AnswerMessage</code>，之后创建<code>peerconnection</code>，接收回调sdp成功回调，发送<code>offer</code> signal信息，载体为<code>SignalMessage</code></li><li>发送者接收到<code>offer</code>消息，设置remoteDescription之后，创建<code>answer</code> signal消息，发送给对端</li><li>接收端收到<code>answer</code>消息，设置remoteDescription</li><li>交换ICE信息</li></ul><blockquote><p>SignalMessage定义如下</p></blockquote><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-json codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:#ff79c6">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;offer&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token comment" style="color:#6272a4">//类型包括offer,answer,icecandidate</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property">&quot;sdp&quot;</span><span class="token operator" style="color:#ff79c6">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property">&quot;sdp&quot;</span><span class="token operator" style="color:#ff79c6">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;v=0\r\no=- 6357572066912248814 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\na=group:BUNDLE audio video\r\na=msid-semantic: WMS ARDAMS\r\nm=audio 9 UDP\/TLS\/RTP\/SAVPF 111 103 9 102 0 8 105 13 110 113 126\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:gvbe\r\na=ice-pwd:OWS+1ww1NcGoreyoLqlrEtKJ\r\na=ice-options:trickle renomination\r\na=fingerprint:sha-256 14:9A:43:E9:AF:D6:E9:81:63:61:7F:6E:49:32:CE:BB:32:7C:8A:4B:EB:5F:D7:94:AF:A9:D9:B5:0C:B6:91:BE\r\na=setup:actpass\r\na=mid:audio\r\na=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level\r\na=sendrecv\r\na=rtcp-mux\r\na=rtpmap:111 opus\/48000\/2\r\na=rtcp-fb:111 transport-cc\r\na=fmtp:111 minptime=10;useinbandfec=1\r\na=rtpmap:103 ISAC\/16000\r\na=rtpmap:9 G722\/8000\r\na=rtpmap:102 ILBC\/8000\r\na=rtpmap:0 PCMU\/8000\r\na=rtpmap:8 PCMA\/8000\r\na=rtpmap:105 CN\/16000\r\na=rtpmap:13 CN\/8000\r\na=rtpmap:110 telephone-event\/48000\r\na=rtpmap:113 telephone-event\/16000\r\na=rtpmap:126 telephone-event\/8000\r\na=ssrc:3585782204 cname:qXVJW4Pt43RfNLoC\r\na=ssrc:3585782204 msid:ARDAMS ARDAMSa0\r\na=ssrc:3585782204 mslabel:ARDAMS\r\na=ssrc:3585782204 label:ARDAMSa0\r\nm=video 9 UDP\/TLS\/RTP\/SAVPF 100 96 97 98 99 101 127 124 104 125\r\nc=IN IP4 0.0.0.0\r\na=rtcp:9 IN IP4 0.0.0.0\r\na=ice-ufrag:gvbe\r\na=ice-pwd:OWS+1ww1NcGoreyoLqlrEtKJ\r\na=ice-options:trickle renomination\r\na=fingerprint:sha-256 14:9A:43:E9:AF:D6:E9:81:63:61:7F:6E:49:32:CE:BB:32:7C:8A:4B:EB:5F:D7:94:AF:A9:D9:B5:0C:B6:91:BE\r\na=setup:actpass\r\na=mid:video\r\na=extmap:2 urn:ietf:params:rtp-hdrext:toffset\r\na=extmap:3 http:\/\/www.webrtc.org\/experiments\/rtp-hdrext\/abs-send-time\r\na=extmap:4 urn:3gpp:video-orientation\r\na=extmap:5 http:\/\/www.ietf.org\/id\/draft-holmer-rmcat-transport-wide-cc-extensions-01\r\na=extmap:6 http:\/\/www.webrtc.org\/experiments\/rtp-hdrext\/playout-delay\r\na=extmap:7 http:\/\/www.webrtc.org\/experiments\/rtp-hdrext\/video-content-type\r\na=extmap:8 http:\/\/www.webrtc.org\/experiments\/rtp-hdrext\/video-timing\r\na=sendrecv\r\na=rtcp-mux\r\na=rtcp-rsize\r\na=rtpmap:96 VP8\/90000\r\na=rtcp-fb:96 goog-remb\r\na=rtcp-fb:96 transport-cc\r\na=rtcp-fb:96 ccm fir\r\na=rtcp-fb:96 nack\r\na=rtcp-fb:96 nack pli\r\na=rtpmap:97 rtx\/90000\r\na=fmtp:97 apt=96\r\na=rtpmap:98 VP9\/90000\r\na=rtcp-fb:98 goog-remb\r\na=rtcp-fb:98 transport-cc\r\na=rtcp-fb:98 ccm fir\r\na=rtcp-fb:98 nack\r\na=rtcp-fb:98 nack pli\r\na=rtpmap:99 rtx\/90000\r\na=fmtp:99 apt=98\r\na=rtpmap:100 H264\/90000\r\na=rtcp-fb:100 goog-remb\r\na=rtcp-fb:100 transport-cc\r\na=rtcp-fb:100 ccm fir\r\na=rtcp-fb:100 nack\r\na=rtcp-fb:100 nack pli\r\na=fmtp:100 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\r\na=rtpmap:101 rtx\/90000\r\na=fmtp:101 apt=100\r\na=rtpmap:127 red\/90000\r\na=rtpmap:124 rtx\/90000\r\na=fmtp:124 apt=127\r\na=rtpmap:104 ulpfec\/90000\r\na=rtpmap:125 flexfec-03\/90000\r\na=rtcp-fb:125 goog-remb\r\na=rtcp-fb:125 transport-cc\r\na=fmtp:125 repair-window=10000000\r\na=ssrc-group:FID 4087522884 3825769918\r\na=ssrc-group:FEC-FR 4087522884 2385199861\r\na=ssrc:4087522884 cname:qXVJW4Pt43RfNLoC\r\na=ssrc:4087522884 msid:ARDAMS ARDAMSv0\r\na=ssrc:4087522884 mslabel:ARDAMS\r\na=ssrc:4087522884 label:ARDAMSv0\r\na=ssrc:3825769918 cname:qXVJW4Pt43RfNLoC\r\na=ssrc:3825769918 msid:ARDAMS ARDAMSv0\r\na=ssrc:3825769918 mslabel:ARDAMS\r\na=ssrc:3825769918 label:ARDAMSv0\r\na=ssrc:2385199861 cname:qXVJW4Pt43RfNLoC\r\na=ssrc:2385199861 msid:ARDAMS ARDAMSv0\r\na=ssrc:2385199861 mslabel:ARDAMS\r\na=ssrc:2385199861 label:ARDAMSv0\r\n&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:#ff79c6">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;offer&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div></div></div><ul><li>ICE candidate</li></ul><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-json codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#f8f8f2;background-color:#262833"><div class="token-line" style="color:#f8f8f2"><span class="token punctuation" style="color:#f8f8f2">{</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property">&quot;type&quot;</span><span class="token operator" style="color:#ff79c6">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;candidate&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property">&quot;label&quot;</span><span class="token operator" style="color:#ff79c6">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property">&quot;id&quot;</span><span class="token operator" style="color:#ff79c6">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;&quot;</span><span class="token punctuation" style="color:#f8f8f2">,</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain">    </span><span class="token property">&quot;candidate&quot;</span><span class="token operator" style="color:#ff79c6">:</span><span class="token plain"> </span><span class="token string" style="color:#f1fa8c">&quot;&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#f8f8f2"><span class="token plain"></span><span class="token punctuation" style="color:#f8f8f2">}</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="音视频会话交互状态"></a>音视频会话交互状态<a aria-hidden="true" tabindex="-1" class="hash-link" href="#音视频会话交互状态" title="Direct link to heading">#</a></h3><blockquote><p>重点解决同一用户不同会话可能会出现的同时收到接听电话，可能造成的非一对一通话问题。音视频通信信令都是透传消息，且跟普通消息不一样，不再进行当前用户同步，也即时透传消息不向自己发送
对于音视频消息组织同一用户的不同session发起的会话。</p></blockquote><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="发送者"></a>发送者<a aria-hidden="true" tabindex="-1" class="hash-link" href="#发送者" title="Direct link to heading">#</a></h4><ul><li>发送者发起通话请求，修改状态为<code>OUTGOING</code></li><li>如果对方同意接听，接收者会收到answer消息，这时将消息设置为<code>CONNECTING</code>，如果此时发送者存在多用户会话，在接收到answer消息后，会检查状态是否为<code>OUTGOING</code>,否则结束会话</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="接收者"></a>接收者<a aria-hidden="true" tabindex="-1" class="hash-link" href="#接收者" title="Direct link to heading">#</a></h4><ul><li>接收对方发起的callStart消息，如果此时正在接听，则拒绝接听此时发起的会话，否则将此时状态设置为<code>STATUS_INCOMING</code></li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="参考资料"></a>参考资料<a aria-hidden="true" tabindex="-1" class="hash-link" href="#参考资料" title="Direct link to heading">#</a></h2><ul><li><a href="http://www.52im.net/thread-356-1-1.html" target="_blank" rel="noopener noreferrer">新手入门：到底什么是WebRTC服务器，以及它是如何联接通话的？</a></li><li><a href="http://www.52im.net/thread-442-1-1.html" target="_blank" rel="noopener noreferrer">WebRTC实时音视频技术基础：基本架构和协议栈</a></li><li><a href="https://mp.weixin.qq.com/s/NsiU8rVYYMbDjVBGZlr3Xg" target="_blank" rel="noopener noreferrer">WebRTC　简介</a></li><li><a href="https://zhuanlan.zhihu.com/p/31717622" target="_blank" rel="noopener noreferrer">【音视频开发】开发小白如何成为音视频专家？</a></li></ul></div></article><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/concept/tech-doc"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« 即时聊天系统技术文档</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/concept/muti-conference-rtc"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">多人音视频会话方案预研 »</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#网络基础" class="table-of-contents__link">网络基础</a></li><li><a href="#webrtc实时音视频技术的整体架构介绍" class="table-of-contents__link">WebRTC实时音视频技术的整体架构介绍</a></li><li><a href="#webrtc服务器" class="table-of-contents__link">WebRTC服务器</a><ul><li><a href="#webrtc协议概述" class="table-of-contents__link">WebRTC协议概述</a></li><li><a href="#信令与视频通话" class="table-of-contents__link">信令与视频通话</a></li><li><a href="#信令交换流程" class="table-of-contents__link">信令交换流程</a></li></ul></li><li><a href="#实践" class="table-of-contents__link">实践</a><ul><li><a href="#熟悉webrtc相关api" class="table-of-contents__link">熟悉WebRTC相关API</a></li><li><a href="#定义通话信令格式" class="table-of-contents__link">定义通话信令格式</a></li><li><a href="#web-rtc核心api流程" class="table-of-contents__link">web-rtc核心API流程</a></li><li><a href="#消息交互流程" class="table-of-contents__link">消息交互流程</a></li><li><a href="#音视频会话交互状态" class="table-of-contents__link">音视频会话交互状态</a></li></ul></li><li><a href="#参考资料" class="table-of-contents__link">参考资料</a></li></ul></div></div></div></div></main></div></div><footer class="footer_mib0 section_3Kiu"><div class="footer__inner_z0Le section--inner_2xOo"><div class="footer__column_3Npq footer__column--left_1EuR"><img alt="FshareIM logo" class="footer__logo_29Wo" src="/img/footer/fsharechat.svg" title="飞享IM 做技术自主可控的即时通讯IM"><p class="footer__tagline_2F15">FshareIM是一个技术自主可控即时IM通讯系统,适于私有化部署</p><a class="footer__github_8UHO button_Ni2_ button--icon_3YKU button--secondary_1x2U button--xsmall_3jz_" href="https://github.com/fsharechat" rel="noopener noreferrer" target="_blank"><img alt="GitHub logo" height="22" src="/img/github.svg" title="GitHub" width="22">Star us on GitHub</a></div><div class="footer__column_3Npq footer__column--right_1XPX"><div class="footer__links_3WB8"><ul class="footer__items_3gGI"><li class="footer__title_1y7h">飞享IM</li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="/docs/introduction/">文档</a></li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="https://github.com/orgs/fsharechat/projects/1" rel="noopener noreferrer" target="_blank">路线图</a></li></ul></div><div class="footer__links_3WB8"><ul class="footer__items_3gGI"><li class="footer__title_1y7h">社区</li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="/community/">公众号</a></li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="/community/">QQ群</a></li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="https://weibo.com/comsince" rel="noopener noreferrer" target="_blank">微博</a></li></ul></div><div class="footer__links_3WB8"><ul class="footer__items_3gGI"><li class="footer__title_1y7h">更多</li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="/blog/">博客</a></li><li class="footer__item_1JzF"><a class="footer__link_2PDg" href="https://github.com/fsharechat" rel="noopener noreferrer" target="_blank">GitHub</a></li></ul></div></div></div><div class="footer__bottom_2RpL"><p class="footer__copyright_1o2i">Copyright © 2020 Fsharechat</p></div></footer></div>
<script src="/styles.83dda306.js" defer="defer"></script>
<script src="/main.d9b69b4b.js" defer="defer"></script>
<script src="/common.b5dd947b.js" defer="defer"></script>
<script src="/1be78505.aae07415.js" defer="defer"></script>
<script src="/935f2afb.057038a3.js" defer="defer"></script>
<script src="/17896441.f99ec223.js" defer="defer"></script>
<script src="/c935443e.dae8f64a.js" defer="defer"></script>
</body>
</html>